<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>競技かるた 決まり字変化流し</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --sub:#9ca3af; --ok:#10b981; --ng:#ef4444; --accent:#6366f1; }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a 30%,#0b1220);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:min(920px,100%);display:grid;gap:16px}
    .title{font-size:24px;font-weight:700;letter-spacing:.02em}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #253047;color:var(--sub);font-size:12px}
    .id{font-size:40px;font-weight:800;letter-spacing:.06em}
    .muted{color:var(--sub)}
    .progress{height:8px;background:#0b1220;border:1px solid #263042;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#14b8a6)}
    .inputrow{display:flex;gap:12px;align-items:center}
    input[type="text"]{flex:1;min-width:140px;background:#0b1220;border:1px solid #263042;color:var(--ink);padding:12px 14px;border-radius:12px;font-size:16px;outline:none}
    input[type="text"]:focus{border-color:#334155;box-shadow:0 0 0 4px rgba(99,102,241,.15)}
    button{background:var(--accent);color:white;border:none;border-radius:12px;padding:12px 16px;font-size:15px;font-weight:700;cursor:pointer}
    button.secondary{background:#182033}
    .result{font-size:16px}
    .ok{color:var(--ok);font-weight:700}
    .ng{color:var(--ng);font-weight:700}
    .small{font-size:12px;color:var(--sub)}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    details summary{cursor:pointer;color:#cbd5e1}
    .kbd{border:1px solid #374151;background:#0b1220;border-radius:6px;padding:2px 6px}
    @media (min-width:720px){ .grid{grid-template-columns:2fr 1fr} }

    /* ▼ 画像表示 */
    .imgwrap{
      margin-top:12px;
      background-color:#0b1220;
      
      /* ▼ 背景画像を設定（背景＋カード画像の二層構造になる） */
      background-image:url('background.png');   /* 同階層にある背景画像 */
      background-position:center;
      background-size:cover;                  /* 画像全体を見せたいなら contain / 埋め尽くすなら cover */
      background-repeat:no-repeat;
      background-clip:padding-box;              /* 枠線の下に背景が回り込まないように */
    
      border:1px solid #263042;
      border-radius:12px;
      padding:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:380px; /* 画像未読込でも高さを確保 */
    }

    .imgwrap img{
      max-width:100%;
      max-height:360px;
      display:block;
      border-radius:8px;
    }

    /* ▼ 決まり字一覧：行スタイル＋6分類カラー（改良版） */
    .list-row{
      padding:4px 8px;
      border-radius:8px;
      margin:2px 0;
      border:1px solid transparent;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .list-row .lab{ font-size:11px; opacity:.95; }
    
    /* 未読 */
    .unread-stable{   /* 未読・不変 */
      background:#0b1220;
      border-color:#334155;
      color:#cbd5e1;
    }
    .unread-changed{  /* 未読・変化中（藍） */
      background:rgba(79,70,229,.24);   /* indigo-600 */
      border-color:#6366f1;             /* indigo-500 */
      color:#e5e7eb;
    }
    
    /* 既読・正解 */
    .read-stable-ok{  /* 不変・正解（緑） */
      background:rgba(34,197,94,.32);   /* green-500 */
      border-color:#22c55e;
      color:#ffffff;
    }
    .read-changed-ok{ /* 変化・正解（青） ←緑と明確に分離 */
      background:rgba(59,130,246,.30);  /* blue-500 */
      border-color:#3b82f6;
      color:#ffffff;
    }
    
    /* 既読・誤答 */
    .read-stable-ng{  /* 不変・誤答（赤） */
      background:rgba(239,68,68,.30);   /* red-500 */
      border-color:#ef4444;
      color:#ffffff;                    /* 文字を白に */
    }
    .read-changed-ng{ /* 変化・誤答（橙） */
      background:rgba(245,158,11,.35);  /* amber-500（濃いめ） */
      border-color:#f59e0b;
      color:#ffffff;                    /* 文字を白に（見やすく） */
    }

    /* ▼ 決まり字一覧：行スタイル＋6分類カラー */
    .tmp-list-row{
      padding:4px 8px;
      border-radius:8px;
      margin:2px 0;
      border:1px solid transparent;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .tmp-list-row .lab{ font-size:11px; opacity:.9; }
    .tmp-unread-stable{  background:#0b1220;           border-color:#334155; color:#cbd5e1; } /* 未読・不変 */
    .tmp-unread-changed{  background:rgba(99,102,241,.18); border-color:#6366f1; color:#e5e7eb; } /* 未読・変化中(藍) */
    .tmp-read-stable-ok{  background:rgba(16,185,129,.18); border-color:#10b981; color:#e5e7eb; }  /* 既読・不変・正解(緑) */
    .tmp-read-changed-ok{ background:rgba(20,184,166,.20); border-color:#14b8a6; color:#e5e7eb; }  /* 既読・変化・正解(青緑) */
    .tmp-read-stable-ng{  background:rgba(239,68,68,.18);  border-color:#ef4444; color:#e5e7eb; }  /* 既読・不変・誤答(赤) */
    .tmp-read-changed-ng{ background:rgba(245,158,11,.20);  border-color:#f59e0b; color:#1f2937; }  /* 既読・変化・誤答(橙) */

  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">競技かるた 決まり字変化 ver2.10</div>
    <div class="grid">
      <div class="card">

        <div class="row" style="display:none;">
          <div>
            <div class="muted small">現在の出題（札番号）</div>
            <div class="id mono" id="qid">-</div>
          </div>
          <div>
            <div class="pill" id="statusPill">未開始</div>
          </div>
        </div>


        <div class="row" style="margin-top:10px;">
          <div class="muted small">進捗</div>
          <div class="muted small"><span id="progressText">0 / 100</span></div>
        </div>
        <div class="progress" aria-hidden="true"><div id="bar" class="bar"></div></div>
        
          <div class="imgwrap">
            <img id="cardImg" alt="札画像" />
          </div>
        <form id="answerForm" style="margin-top:16px;">
          <div class="inputrow">
            <input id="answerInput" type="text" placeholder="現時点の決まり字を入力（Enter可）" autocomplete="off" />
            <button type="submit">答える</button>
            <button type="button" class="secondary" id="skipBtn" title="答えずに次の出題へ">スキップ</button>
          </div>
        </form>

        <div class="result" id="result" style="margin-top:10px;"></div>
        <div class="small" style="display:none; margin-top:8px;">※※※※※※</div>

        <div class="footer" style="margin-top:16px;">
          <div class="small">残り札：<span id="remain">100</span> 枚</div>
          <div class="row">
            <button type="button" class="secondary" id="resetBtn">リセット</button>
          </div>
        </div>
      </div>





      <div class="card">
        <div class="muted small" style="display:none; margin-bottom:8px;">説明</div>
        <div class="small" style="display:none;">※※※※※※※※※※※※※※※※※</div>
        <details style="margin-top:10px;">
          <summary>決まり字一覧を表示</summary>
          <div id="list" class="small" style="margin-top:8px;max-height:460px;overflow:auto;"></div>
        </details>
      </div>
    </div>
  </div>

  <script>
    // ====== カード定義（id と固定の「全札前提の決まり字」）======
    const CARDS = [
      {id:87, s:"む"},{id:18, s:"す"},{id:57, s:"め"},{id:22, s:"ふ"},{id:70, s:"さ"},{id:81, s:"ほ"},{id:77, s:"せ"},
      {id:74, s:"うか"},{id:65, s:"うら"},{id:23, s:"つき"},{id:13, s:"つく"},{id:40, s:"しの"},{id:37, s:"しら"},{id:100, s:"もも"},{id:66, s:"もろ"},{id:71, s:"ゆう"},{id:46, s:"ゆら"},
      {id:61, s:"いに"},{id:21, s:"いまこ"},{id:63, s:"いまは"},{id:75, s:"ちぎりお"},{id:42, s:"ちぎりき"},{id:17, s:"ちは"},
      {id:33, s:"ひさ"},{id:35, s:"ひとは"},{id:99, s:"ひとも"},{id:50, s:"きみがためお"},{id:15, s:"きみがためは"},{id:91, s:"きり"},
      {id:96, s:"はなさ"},{id:9, s:"はなの"},{id:2, s:"はるす"},{id:67, s:"はるの"},{id:47, s:"やえ"},{id:59, s:"やす"},{id:32, s:"やまが"},{id:28, s:"やまざ"},
      {id:93, s:"よのなかは"},{id:83, s:"よのなかよ"},{id:85, s:"よも"},{id:62, s:"よを"},{id:51, s:"かく"},{id:6, s:"かさ"},{id:98, s:"かぜそ"},{id:48, s:"かぜを"},
      {id:49, s:"みかき"},{id:27, s:"みかの"},{id:90, s:"みせ"},{id:14, s:"みち"},{id:94, s:"みよ"},
      {id:73, s:"たか"},{id:55, s:"たき"},{id:4, s:"たご"},{id:16, s:"たち"},{id:89, s:"たま"},{id:34, s:"たれ"},
      {id:41, s:"こい"},{id:29, s:"こころあ"},{id:68, s:"こころに"},{id:97, s:"こぬ"},{id:24, s:"この"},{id:10, s:"これ"},
      {id:60, s:"おおえ"},{id:95, s:"おおけ"},{id:44, s:"おおこ"},{id:5, s:"おく"},{id:26, s:"おぐ"},{id:72, s:"おと"},{id:82, s:"おも"},
      {id:8, s:"わがい"},{id:92, s:"わがそ"},{id:38, s:"わすら"},{id:54, s:"わすれ"},{id:76, s:"わたのはらこ"},{id:11, s:"わたのはらや"},{id:20, s:"わび"},
      {id:80, s:"ながか"},{id:84, s:"ながら"},{id:53, s:"なげき"},{id:86, s:"なげけ"},{id:36, s:"なつ"},{id:25, s:"なにし"},{id:88, s:"なにわえ"},{id:19, s:"なにわが"},
      {id:43, s:"あい"},{id:79, s:"あきか"},{id:1, s:"あきの"},{id:52, s:"あけ"},{id:39, s:"あさじ"},{id:31, s:"あさぼらけあ"},{id:64, s:"あさぼらけう"},
      {id:3, s:"あし"},{id:12, s:"あまつ"},{id:7, s:"あまの"},{id:56, s:"あらざ"},{id:69, s:"あらし"},{id:30, s:"ありあ"},{id:58, s:"ありま"},{id:78, s:"あわじ"},{id:45, s:"あわれ"}
    ];

    // ====== 文字単位ユーティリティ（UTF-8/16のサロゲート対策に Array.from を使う）======
    const toChars = (s) => Array.from(s); // code point 単位
    const lcpChars = (a, b) => {
      const ca = toChars(a), cb = toChars(b);
      const n = Math.min(ca.length, cb.length);
      let i = 0;
      while (i < n && ca[i] === cb[i]) i++;
      return i;
    };
    const prefixChars = (s, k) => {
      const cs = toChars(s);
      if (k > cs.length) k = cs.length;
      return cs.slice(0, k).join("");
    };

    // ====== 状態 ======
    let remaining = [];               // 残り札（Card配列）
    let id2s = new Map();             // id -> s
    let history = new Map();          // id -> { changedAtRead: boolean, correct: boolean }
    let reads = [];                   // シャッフル済みの 1..100
    let idx = 0;                      // 現在の出題インデックス
    let awaitingNext = false; // 「答える」後に手動で次へ進む待機中かどうか
    let nextTimer = null;     // 自動遷移タイマーID
    let advanced = false;     // この設問で既に進んだかのガード

    // 共通：次へ進む
    const advanceToNext = () => {
      // 追加：二重進行防止
      if (advanced) return;
      advanced = true;

      // 追加：手動進行時は保留中タイマーを無効化
      if (nextTimer) { clearTimeout(nextTimer); nextTimer = null; }    
      if (idx >= reads.length) return;
      
      removeById(currentId());
      idx++;
      inputEl.disabled = false;     // 次の問題で入力可能に戻す
      awaitingNext = false;
      skipBtn.textContent = "スキップ";
      showQuestion();
    };

    // ====== DOM ======
    const qidEl = document.getElementById("qid");
    const resultEl = document.getElementById("result");
    const progressTextEl = document.getElementById("progressText");
    const barEl = document.getElementById("bar");
    const remainEl = document.getElementById("remain");
    const statusPill = document.getElementById("statusPill");
    const formEl = document.getElementById("answerForm");
    const inputEl = document.getElementById("answerInput");
    const resetBtn = document.getElementById("resetBtn");
    const skipBtn = document.getElementById("skipBtn");
    const listEl = document.getElementById("list");
    const imgEl = document.getElementById("cardImg");


    // ====== ヘルパ ======
    const shuffle = (arr) => {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    };

    const expectedPrefix = (s) => {
      let maxL = 0;
      for (const t of remaining) {
        if (t.s === s) continue;
        const l = lcpChars(s, t.s);
        if (l > maxL) maxL = l;
      }
      const need = Math.min(toChars(s).length, maxL + 1);
      return prefixChars(s, need);
    };

    const removeById = (id) => {
      const k = remaining.findIndex(c => c.id === id);
      if (k >= 0) remaining.splice(k, 1);
    };

    const currentId = () => reads[idx];
    const curS = () => id2s.get(currentId());

    const updateProgress = () => {
      progressTextEl.textContent = `${idx} / 100`;
      const pct = (idx / 100) * 100;
      barEl.style.width = `${pct}%`;
      remainEl.textContent = remaining.length.toString();
    };

    const renderList = () => {
      const remIds = new Set(remaining.map(c => c.id));
    
      const rows = CARDS.slice().map(c => {
        let cls = "", label = "";
    
        if (remIds.has(c.id)) {
          // 未読：今この瞬間に変化しているか
          const changedNow = (expectedPrefix(c.s) !== c.s);
          cls   = changedNow ? "unread-changed" : "unread-stable";
          label = changedNow ? "未読・変化中" : "未読・不変";
        } else {
          // 既読：出題時の状態＋正誤
          const h = history.get(c.id);
          if (!h) {
            // 万一履歴がない場合（想定外）：不明扱い→未読・不変相当
            cls = "unread-stable";
            label = "既読・不明";
          } else {
            const part1 = h.changedAtRead ? "changed" : "stable";
            const part2 = h.correct ? "ok" : "ng";
            cls = `read-${part1}-${part2}`;
            label = `${h.changedAtRead ? "変化" : "不変"}・${h.correct ? "正解" : "誤答"}`;
          }
        }
    
        const idStr = String(c.id).padStart(3, "0");
        return `<div class="list-row ${cls}" title="${label}">
                  <span><span class="mono">#${idStr}</span>：${c.s}</span>
                  <span class="lab">${label}</span>
                </div>`;
      }).join("");
    
      listEl.innerHTML = rows;
    };



    
    
    const showQuestion = () => {
      advanced = false;
      if (nextTimer) { clearTimeout(nextTimer); nextTimer = null; }
      skipBtn.textContent = "スキップ";
      
      if (idx >= reads.length) {
        qidEl.textContent = "終了";
        statusPill.textContent = "完了";
        resultEl.innerHTML = `<span class="ok">お疲れさまでした！</span> 全問終了です。`;
        inputEl.disabled = true;
        if (imgEl) { imgEl.removeAttribute("src"); imgEl.alt = ""; imgEl.style.visibility = "hidden"; }
        renderList();
        return;
      }
    
      const id = String(currentId());
      qidEl.textContent = id;
      statusPill.textContent = "出題中";
      resultEl.textContent = "";
      inputEl.value = "";
      inputEl.focus();
      updateProgress();
    
      // ▼ 画像切り替え（同階層の id.png を表示）
      if (imgEl) {
        imgEl.style.visibility = "hidden";
        imgEl.onload = () => { imgEl.style.visibility = "visible"; };
        imgEl.onerror = () => {
          imgEl.style.visibility = "visible";
          imgEl.alt = `画像が見つかりません（${id}.png）`;
        };
        imgEl.src = `${id}.png`;
        imgEl.alt = `札画像 ${id}.png`;
      }
      renderList();
    };

    // ====== 追加：自動で次へ進むまでの待ち時間（ミリ秒）。0にすると自動で進まない ======
    const AUTO_NEXT_MS = 3500;
    
    // submitAnswer（判定を表示→少し待ってから次へ）
    const submitAnswer = () => {
      if (idx >= reads.length) return;
      if (inputEl.disabled) return; // 既に判定済みで待機中なら無視
    
      const s = curS();
      if (!s) {
        resultEl.innerHTML = `<span class="ng">データ不整合</span>：このIDの札が見つかりません`;
        return;
      }
    
      const expect = expectedPrefix(s);
      const user = inputEl.value.trim();
      const correct = (user === expect);
      const changedAtRead = (expect !== s);
      
      if (correct) {
        resultEl.innerHTML = `<span class="ok">OK</span>`;
        statusPill.textContent = "判定：正解";
      } else {
        resultEl.innerHTML = `<span class="ng">NG</span>：正解は <b class="mono">${expect}</b>`;
        statusPill.textContent = "判定：不正解";
      }
      history.set(currentId(), { changedAtRead, correct });

    
      // 判定中は入力をロック
      inputEl.disabled = true;
    
      if (AUTO_NEXT_MS > 0) {
        // 自動で次へ
        nextTimer = setTimeout(advanceToNext, AUTO_NEXT_MS);
      } else {
        // 手動で次へ（ボタン表示だけ変えて待機）
        awaitingNext = true;
        skipBtn.textContent = "次へ";
      }
    };
    
    const skipQuestion = () => {
      if (idx >= reads.length) return;
      const s = curS();
      const changedAtRead = (expectedPrefix(s) !== s);
      history.set(currentId(), { changedAtRead, correct: false }); // スキップ＝誤答扱い
      advanceToNext();
    };


    const resetAll = () => {
      remaining = CARDS.slice();
      id2s = new Map(CARDS.map(c => [c.id, c.s]));
      reads = shuffle(Array.from({length:100}, (_,i)=>i+1));
      idx = 0;

      if (nextTimer) { clearTimeout(nextTimer); nextTimer = null; }
      advanced = false;
      awaitingNext = false;
      history.clear();
      
      inputEl.disabled = false;
      statusPill.textContent = "準備完了";
      skipBtn.textContent = "スキップ";
      updateProgress();
      showQuestion();
    };

    
    // ====== イベント ======
    formEl.addEventListener("submit", (e) => { e.preventDefault(); submitAnswer(); });
    resetBtn.addEventListener("click", resetAll);
    skipBtn.addEventListener("click", skipQuestion);
    
    // ====== 起動 ======
    renderList();
    resetAll();
  </script>
</body>
</html>
